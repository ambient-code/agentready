#!/bin/bash
# Sync version numbers across project files
# Used by semantic-release during the release process
# Generated by AgentReady Bootstrap

set -e

VERSION=${1:-$(grep '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')}
TODAY=$(date +%Y-%m-%d)

echo "Syncing version to $VERSION (date: $TODAY)"

# Update pyproject.toml (already done by semantic-release, but being explicit)
sed -i.bak "s/version = \".*\"/version = \"$VERSION\"/" pyproject.toml

# Update __init__.py if it exists
if [ -f "src/{{ project_name }}/__init__.py" ]; then
  sed -i.bak "s/__version__ = \".*\"/__version__ = \"$VERSION\"/" src/{{ project_name }}/__init__.py
  echo "  - Updated src/{{ project_name }}/__init__.py"
fi
{%- if has_claude_md %}

# Update CLAUDE.md version numbers
if [ -f "CLAUDE.md" ]; then
  # Update version patterns (v1.2.3)
  sed -i.bak "s/v[0-9][0-9]*\.[0-9][0-9]*\.[0-9][0-9]*/v$VERSION/g" CLAUDE.md

  # Update "Last Updated" date at top
  awk -v today="$TODAY" '
    !updated && /\*\*Last Updated\*\*:/ {
      sub(/[0-9]{4}-[0-9]{2}-[0-9]{2}/, today);
      updated=1
    }
    {print}
  ' CLAUDE.md > CLAUDE.md.tmp && mv CLAUDE.md.tmp CLAUDE.md

  # Update "Last Updated" date at bottom (if exists)
  awk -v today="$TODAY" '
    /\*\*Last Updated\*\*:.*by/ {
      sub(/[0-9]{4}-[0-9]{2}-[0-9]{2}/, today);
    }
    {print}
  ' CLAUDE.md > CLAUDE.md.tmp && mv CLAUDE.md.tmp CLAUDE.md

  echo "  - Updated CLAUDE.md"
fi
{%- endif %}

# Clean up backup files
rm -f *.bak
rm -f src/**/*.bak 2>/dev/null || true

echo "âœ“ Version synced successfully"
echo "  - Version: $VERSION"
echo "  - Date: $TODAY"
